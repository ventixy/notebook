<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.15" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.52" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://x.app/posts/db/mysql-lock.html"><meta property="og:site_name" content="doc"><meta property="og:title" content="MySQL事务和锁监控 | 锁的范围 | 死锁分析"><meta property="og:description" content="MySQL事务和锁监控 information_schema 是 MySQL 提供的一个系统数据库，用于存储有关数据库结构和元数据的信息 performance_schema 是一个动态性能监控工具，在 8.0 版本中经历了一系列重要的改进和增强 关于这两个系统数据库更多的信息参照：Information_Schema，Performance Sche..."><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2025-01-22T15:07:03.000Z"><meta property="article:author" content="ventixy"><meta property="article:tag" content="Database"><meta property="article:tag" content="MySQL"><meta property="article:tag" content="Transaction"><meta property="article:tag" content="Locks"><meta property="article:published_time" content="2023-02-09T00:00:00.000Z"><meta property="article:modified_time" content="2025-01-22T15:07:03.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"MySQL事务和锁监控 | 锁的范围 | 死锁分析","image":[""],"datePublished":"2023-02-09T00:00:00.000Z","dateModified":"2025-01-22T15:07:03.000Z","author":[{"@type":"Person","name":"ventixy","url":"https://www.ventix.top"}]}</script><link rel="icon" href="/jav.ico"><title>MySQL事务和锁监控 | 锁的范围 | 死锁分析 | doc</title><meta name="description" content="MySQL事务和锁监控 information_schema 是 MySQL 提供的一个系统数据库，用于存储有关数据库结构和元数据的信息 performance_schema 是一个动态性能监控工具，在 8.0 版本中经历了一系列重要的改进和增强 关于这两个系统数据库更多的信息参照：Information_Schema，Performance Sche...">
    <link rel="preload" href="/assets/style-DlWEdz0Y.css" as="style"><link rel="stylesheet" href="/assets/style-DlWEdz0Y.css">
    <link rel="modulepreload" href="/assets/app-DROnWr0m.js"><link rel="modulepreload" href="/assets/mysql-lock.html--StAy2EF.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-D_ZlnIN8.js" as="script"><link rel="prefetch" href="/assets/blog.html-DwwkmZ0G.js" as="script"><link rel="prefetch" href="/assets/intro.html-I_AmfdE_.js" as="script"><link rel="prefetch" href="/assets/index.html-Cfs5a7w_.js" as="script"><link rel="prefetch" href="/assets/index.html-CwwdGEYJ.js" as="script"><link rel="prefetch" href="/assets/资源分享.html-BrjHZB0c.js" as="script"><link rel="prefetch" href="/assets/index.html-CO-v-H9K.js" as="script"><link rel="prefetch" href="/assets/index.html-DucEf7Lr.js" as="script"><link rel="prefetch" href="/assets/Gradle.html-BS-9FbJH.js" as="script"><link rel="prefetch" href="/assets/index.html-Q8W1exTw.js" as="script"><link rel="prefetch" href="/assets/maven.html-DvBjg9aY.js" as="script"><link rel="prefetch" href="/assets/theme.html-Bsey9s87.js" as="script"><link rel="prefetch" href="/assets/index.html-DbxEvYtT.js" as="script"><link rel="prefetch" href="/assets/index.html-C__O0odw.js" as="script"><link rel="prefetch" href="/assets/index.html-BIsQXsqg.js" as="script"><link rel="prefetch" href="/assets/mybatis.html-Blz2HTDx.js" as="script"><link rel="prefetch" href="/assets/mysql.html-DiHv3nNu.js" as="script"><link rel="prefetch" href="/assets/redis.html-DwYwx1Dd.js" as="script"><link rel="prefetch" href="/assets/security.html-CjkcnAZe.js" as="script"><link rel="prefetch" href="/assets/spring.html-PWFVHRhd.js" as="script"><link rel="prefetch" href="/assets/springboot.html-BBU2BP1T.js" as="script"><link rel="prefetch" href="/assets/index.html-IdIZMqXf.js" as="script"><link rel="prefetch" href="/assets/base.html-BvQD-jbw.js" as="script"><link rel="prefetch" href="/assets/collect.html-DlBzk3mD.js" as="script"><link rel="prefetch" href="/assets/concurrency.html-CEeUSUf_.js" as="script"><link rel="prefetch" href="/assets/jvm.html-B6k7J_Ni.js" as="script"><link rel="prefetch" href="/assets/index.html-Cah-yi3v.js" as="script"><link rel="prefetch" href="/assets/es.html-DY4LBf3d.js" as="script"><link rel="prefetch" href="/assets/rocketmq.html-BDfazwYB.js" as="script"><link rel="prefetch" href="/assets/sys.html-Barxjyky.js" as="script"><link rel="prefetch" href="/assets/index.html-CJ5Wa4QP.js" as="script"><link rel="prefetch" href="/assets/index.html-D4Wcq3-m.js" as="script"><link rel="prefetch" href="/assets/index.html-BbJDkgm_.js" as="script"><link rel="prefetch" href="/assets/index.html-Coa3n3Hg.js" as="script"><link rel="prefetch" href="/assets/index.html-DR0cZ4mG.js" as="script"><link rel="prefetch" href="/assets/idea.html-Blkd1nYU.js" as="script"><link rel="prefetch" href="/assets/mac.html-CpXaFW-E.js" as="script"><link rel="prefetch" href="/assets/picgo.html-ClonGBP1.js" as="script"><link rel="prefetch" href="/assets/website.html-GQvj2id4.js" as="script"><link rel="prefetch" href="/assets/windows.html-DKBmOVvz.js" as="script"><link rel="prefetch" href="/assets/index.html-BU-M60IP.js" as="script"><link rel="prefetch" href="/assets/encoding.html-BQ-JntoY.js" as="script"><link rel="prefetch" href="/assets/index.html-ZliwVf5l.js" as="script"><link rel="prefetch" href="/assets/mysql-binlog.html-CSmw4y1f.js" as="script"><link rel="prefetch" href="/assets/mysql.html-DSyP2b_B.js" as="script"><link rel="prefetch" href="/assets/index.html-B23dS0J5.js" as="script"><link rel="prefetch" href="/assets/env.html-QooT3I3A.js" as="script"><link rel="prefetch" href="/assets/history.html-CE3KyFL6.js" as="script"><link rel="prefetch" href="/assets/jar.html-D6rlAb_8.js" as="script"><link rel="prefetch" href="/assets/index.html-Bfji4wHa.js" as="script"><link rel="prefetch" href="/assets/k8s.html-B8TddkxB.js" as="script"><link rel="prefetch" href="/assets/ks-install.html-Dknks19F.js" as="script"><link rel="prefetch" href="/assets/vm.html-zReePn3b.js" as="script"><link rel="prefetch" href="/assets/index.html-CQPBgzeB.js" as="script"><link rel="prefetch" href="/assets/springboot.html-Bw65ZQL9.js" as="script"><link rel="prefetch" href="/assets/index.html-DFR8u-IS.js" as="script"><link rel="prefetch" href="/assets/index.html-skBLCVk4.js" as="script"><link rel="prefetch" href="/assets/begin.html-Cz0WeJGp.js" as="script"><link rel="prefetch" href="/assets/index.html-DCCcZI_D.js" as="script"><link rel="prefetch" href="/assets/index.html-Xv-qDvXb.js" as="script"><link rel="prefetch" href="/assets/index.html-Bq-8Vy6_.js" as="script"><link rel="prefetch" href="/assets/pywin32.html-BOL7RBPD.js" as="script"><link rel="prefetch" href="/assets/index.html-C3-NsuZp.js" as="script"><link rel="prefetch" href="/assets/damb.html-crO21lF0.js" as="script"><link rel="prefetch" href="/assets/sd.html-b1HJlwoQ.js" as="script"><link rel="prefetch" href="/assets/yolo.html-dA_EZltf.js" as="script"><link rel="prefetch" href="/assets/index.html-BUZofwUX.js" as="script"><link rel="prefetch" href="/assets/env.html-T2lMlwma.js" as="script"><link rel="prefetch" href="/assets/Linux.html-dz35QBV4.js" as="script"><link rel="prefetch" href="/assets/index.html-D3yP6og1.js" as="script"><link rel="prefetch" href="/assets/file.html-BK3K7XRj.js" as="script"><link rel="prefetch" href="/assets/setting.html-GrHd3-wZ.js" as="script"><link rel="prefetch" href="/assets/shell.html-B-JH6cVx.js" as="script"><link rel="prefetch" href="/assets/Docker.html-r3OLH8pk.js" as="script"><link rel="prefetch" href="/assets/index.html-CiBWf5wl.js" as="script"><link rel="prefetch" href="/assets/k8s.html-DsjD8bNW.js" as="script"><link rel="prefetch" href="/assets/index.html-C7c0bD8j.js" as="script"><link rel="prefetch" href="/assets/git.html-CsBA22Np.js" as="script"><link rel="prefetch" href="/assets/gitlab.html-B2SWIzGr.js" as="script"><link rel="prefetch" href="/assets/jenkins.html-BVZU0AmE.js" as="script"><link rel="prefetch" href="/assets/index.html-B961Mr3g.js" as="script"><link rel="prefetch" href="/assets/index.html-1ShnZcPR.js" as="script"><link rel="prefetch" href="/assets/index.html-BIgIeHL4.js" as="script"><link rel="prefetch" href="/assets/index.html-HravfMSW.js" as="script"><link rel="prefetch" href="/assets/Architecture.html-CHNRktBW.js" as="script"><link rel="prefetch" href="/assets/index.html-CyhAU_qz.js" as="script"><link rel="prefetch" href="/assets/Transaction.html-B9yjYvZs.js" as="script"><link rel="prefetch" href="/assets/mysql-index.html-CW3feDyG.js" as="script"><link rel="prefetch" href="/assets/redis-java.html-D0EeaLD3.js" as="script"><link rel="prefetch" href="/assets/redis.html-XsnC88DR.js" as="script"><link rel="prefetch" href="/assets/sql.html-C6VuaHXv.js" as="script"><link rel="prefetch" href="/assets/Hibernate.html-KHj01C24.js" as="script"><link rel="prefetch" href="/assets/index.html-CyrziAO4.js" as="script"><link rel="prefetch" href="/assets/generator.html-qQgL9gDb.js" as="script"><link rel="prefetch" href="/assets/mybatis-resource.html-BY_lNdgR.js" as="script"><link rel="prefetch" href="/assets/mybatis.html-DSMVnRCW.js" as="script"><link rel="prefetch" href="/assets/tk-mybatis.html-BFGLnvUr.js" as="script"><link rel="prefetch" href="/assets/index.html-CO4NuyAm.js" as="script"><link rel="prefetch" href="/assets/Servlet.html-0l_mYnB0.js" as="script"><link rel="prefetch" href="/assets/http.html-Bi4o3jaJ.js" as="script"><link rel="prefetch" href="/assets/jsp.html-DEEAk8Qo.js" as="script"><link rel="prefetch" href="/assets/mvc.html-DsyF2yU6.js" as="script"><link rel="prefetch" href="/assets/nginx.html-jKQ6j87Z.js" as="script"><link rel="prefetch" href="/assets/tomcat.html-0WpzYSmh.js" as="script"><link rel="prefetch" href="/assets/index.html-B8yDzYV6.js" as="script"><link rel="prefetch" href="/assets/crossDomain.html-DvaqPy-U.js" as="script"><link rel="prefetch" href="/assets/excel.html-xLWdi3rs.js" as="script"><link rel="prefetch" href="/assets/log.html-CYw9D3y3.js" as="script"><link rel="prefetch" href="/assets/shiro.html-BF5vtCDQ.js" as="script"><link rel="prefetch" href="/assets/index.html-CHqF4juW.js" as="script"><link rel="prefetch" href="/assets/design.html-BNHiAE5f.js" as="script"><link rel="prefetch" href="/assets/life.html-bFTcTryd.js" as="script"><link rel="prefetch" href="/assets/mvc-core.html-wUuzvpos.js" as="script"><link rel="prefetch" href="/assets/sec.html-KGqpGLn4.js" as="script"><link rel="prefetch" href="/assets/spring.html-MwIvbTHb.js" as="script"><link rel="prefetch" href="/assets/springboot.html-CXnEpghh.js" as="script"><link rel="prefetch" href="/assets/springmvc.html-WRdkSJxa.js" as="script"><link rel="prefetch" href="/assets/transaction.html-D6pgWWIe.js" as="script"><link rel="prefetch" href="/assets/index.html-BCWC4AP1.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ.html-QM5cYtD8.js" as="script"><link rel="prefetch" href="/assets/RockMQ.html-Ch_GhWlR.js" as="script"><link rel="prefetch" href="/assets/Sentinel.html-ZHDX7nHE.js" as="script"><link rel="prefetch" href="/assets/dubbo.html-BTme2ais.js" as="script"><link rel="prefetch" href="/assets/es.html-D7wjbOGJ.js" as="script"><link rel="prefetch" href="/assets/eureka.html-Dp2NcSc2.js" as="script"><link rel="prefetch" href="/assets/gateway.html-xjZch_1y.js" as="script"><link rel="prefetch" href="/assets/hystrix.html-uw5RVXjn.js" as="script"><link rel="prefetch" href="/assets/kafka.html-CYJokAvP.js" as="script"><link rel="prefetch" href="/assets/nacos.html-Yj5bMr64.js" as="script"><link rel="prefetch" href="/assets/zookeeper.html-CQPUsp0n.js" as="script"><link rel="prefetch" href="/assets/index.html-Dikb0qa3.js" as="script"><link rel="prefetch" href="/assets/cron.html-CjLON7zQ.js" as="script"><link rel="prefetch" href="/assets/db.html-W-1yBPCL.js" as="script"><link rel="prefetch" href="/assets/dup.html-BqDM3OR7.js" as="script"><link rel="prefetch" href="/assets/lock.html-BB5j-L6B.js" as="script"><link rel="prefetch" href="/assets/redis.html-BF-NwKM8.js" as="script"><link rel="prefetch" href="/assets/transac.html-s2p1LgG4.js" as="script"><link rel="prefetch" href="/assets/walk.html-Dp9P43Jd.js" as="script"><link rel="prefetch" href="/assets/HashMap源码分析.html-BI7hXDzZ.js" as="script"><link rel="prefetch" href="/assets/Java基础.html-C32A5b2p.js" as="script"><link rel="prefetch" href="/assets/Java常用类库.html-C0BGs6eq.js" as="script"><link rel="prefetch" href="/assets/Java面向对象.html-nn3L2nJP.js" as="script"><link rel="prefetch" href="/assets/index.html-CtGTVYN0.js" as="script"><link rel="prefetch" href="/assets/collection.html-BRT3l3SQ.js" as="script"><link rel="prefetch" href="/assets/generics.html-ChODhwRs.js" as="script"><link rel="prefetch" href="/assets/javaIO.html-Cp7QIig0.js" as="script"><link rel="prefetch" href="/assets/set和map.html-CwfPOlIa.js" as="script"><link rel="prefetch" href="/assets/数组和字符串.html-CP9TKW8x.js" as="script"><link rel="prefetch" href="/assets/index.html-5ZL8T13N.js" as="script"><link rel="prefetch" href="/assets/netty.html-DaVvmLBb.js" as="script"><link rel="prefetch" href="/assets/nio.html-D8lJEOwQ.js" as="script"><link rel="prefetch" href="/assets/socket.html-ByuE3aXD.js" as="script"><link rel="prefetch" href="/assets/theory.html-B6MSMtxR.js" as="script"><link rel="prefetch" href="/assets/Annotation.html-B2n9pARY.js" as="script"><link rel="prefetch" href="/assets/Enum.html-Civ2VX8W.js" as="script"><link rel="prefetch" href="/assets/Jvm内存管理.html-C4ZSOr3k.js" as="script"><link rel="prefetch" href="/assets/Jvm类加载.html-NvUElMM5.js" as="script"><link rel="prefetch" href="/assets/Lambda.html-B8tvye9Q.js" as="script"><link rel="prefetch" href="/assets/index.html-Dtcr-EHv.js" as="script"><link rel="prefetch" href="/assets/Reflection.html-CD4Vn2lU.js" as="script"><link rel="prefetch" href="/assets/Stream.html-BroDjjAO.js" as="script"><link rel="prefetch" href="/assets/bytecode.html-6lHwf3gF.js" as="script"><link rel="prefetch" href="/assets/pt.html-Cif3OiN1.js" as="script"><link rel="prefetch" href="/assets/index.html-DhchgbU4.js" as="script"><link rel="prefetch" href="/assets/lock.html-D1TTihNf.js" as="script"><link rel="prefetch" href="/assets/pool.html-BTxQK462.js" as="script"><link rel="prefetch" href="/assets/thread.html-CmE7wvuJ.js" as="script"><link rel="prefetch" href="/assets/tool.html-BPuW6zfq.js" as="script"><link rel="prefetch" href="/assets/index.html-DxgT_pgj.js" as="script"><link rel="prefetch" href="/assets/base.html-BX5eCtje.js" as="script"><link rel="prefetch" href="/assets/numpy.html-CZEQ4QGc.js" as="script"><link rel="prefetch" href="/assets/opencv.html-BpR9oknm.js" as="script"><link rel="prefetch" href="/assets/pillow.html-B86vO--q.js" as="script"><link rel="prefetch" href="/assets/python.html-XmQw3_Hw.js" as="script"><link rel="prefetch" href="/assets/index.html-D_GnbFrt.js" as="script"><link rel="prefetch" href="/assets/base.html-f-5Vkou8.js" as="script"><link rel="prefetch" href="/assets/data.html-BPQLNC62.js" as="script"><link rel="prefetch" href="/assets/file.html-Bbk5WERE.js" as="script"><link rel="prefetch" href="/assets/function.html-B_HLBr-0.js" as="script"><link rel="prefetch" href="/assets/oop.html-7uokM8fx.js" as="script"><link rel="prefetch" href="/assets/index.html-DgrJyk0n.js" as="script"><link rel="prefetch" href="/assets/numpy.html-B8IznBd4.js" as="script"><link rel="prefetch" href="/assets/pandas.html-DubY9X06.js" as="script"><link rel="prefetch" href="/assets/index.html-DEvz23M2.js" as="script"><link rel="prefetch" href="/assets/css.html-DO0I9jJy.js" as="script"><link rel="prefetch" href="/assets/css2.html-0eTqSdWt.js" as="script"><link rel="prefetch" href="/assets/css3.html-CT49u7qG.js" as="script"><link rel="prefetch" href="/assets/css4.html-BCVvJcau.js" as="script"><link rel="prefetch" href="/assets/index.html-vumYAnBE.js" as="script"><link rel="prefetch" href="/assets/html.html-DToieSLw.js" as="script"><link rel="prefetch" href="/assets/html5.html-CJVAQ00T.js" as="script"><link rel="prefetch" href="/assets/index.html-CY6B6qY4.js" as="script"><link rel="prefetch" href="/assets/dom.html-BAdmJra8.js" as="script"><link rel="prefetch" href="/assets/es6.html-dVA4E8Nd.js" as="script"><link rel="prefetch" href="/assets/js.html-Bcm0p997.js" as="script"><link rel="prefetch" href="/assets/js2.html-4pL0eeYp.js" as="script"><link rel="prefetch" href="/assets/index.html-CaGiyWyN.js" as="script"><link rel="prefetch" href="/assets/ts.html-B9TZGIfc.js" as="script"><link rel="prefetch" href="/assets/ts2.html-Dcp-RYne.js" as="script"><link rel="prefetch" href="/assets/index.html-BTeQ9oGf.js" as="script"><link rel="prefetch" href="/assets/react.html-De5WT4Ta.js" as="script"><link rel="prefetch" href="/assets/ui.html-CBBE3EtH.js" as="script"><link rel="prefetch" href="/assets/vue.html-ERJg2lXk.js" as="script"><link rel="prefetch" href="/assets/index.html-BxrZhi04.js" as="script"><link rel="prefetch" href="/assets/build.html-9odAAR_h.js" as="script"><link rel="prefetch" href="/assets/format.html-Cw7hB_ta.js" as="script"><link rel="prefetch" href="/assets/node.html-rPJJHpWn.js" as="script"><link rel="prefetch" href="/assets/index.html-CjNzuTaA.js" as="script"><link rel="prefetch" href="/assets/index.html-C63ZpJtn.js" as="script"><link rel="prefetch" href="/assets/index.html-DaMEDEVI.js" as="script"><link rel="prefetch" href="/assets/baz.html-BVJMb-uc.js" as="script"><link rel="prefetch" href="/assets/index.html-IPAvUxQR.js" as="script"><link rel="prefetch" href="/assets/ray.html-B-ggUvGo.js" as="script"><link rel="prefetch" href="/assets/404.html-CM5x3cw8.js" as="script"><link rel="prefetch" href="/assets/index.html-MGoDbKxY.js" as="script"><link rel="prefetch" href="/assets/index.html-BLa-Kzc0.js" as="script"><link rel="prefetch" href="/assets/index.html-BqpYgEdJ.js" as="script"><link rel="prefetch" href="/assets/index.html-Y8oKnEXY.js" as="script"><link rel="prefetch" href="/assets/index.html-C2_TJdNe.js" as="script"><link rel="prefetch" href="/assets/index.html-DqOSW3Xz.js" as="script"><link rel="prefetch" href="/assets/index.html-DD-IuxHC.js" as="script"><link rel="prefetch" href="/assets/index.html-CS7jX5OY.js" as="script"><link rel="prefetch" href="/assets/index.html-DMY5QYDi.js" as="script"><link rel="prefetch" href="/assets/index.html-BMbWkolG.js" as="script"><link rel="prefetch" href="/assets/index.html-CnXON0kZ.js" as="script"><link rel="prefetch" href="/assets/index.html-CDi3GDxG.js" as="script"><link rel="prefetch" href="/assets/index.html-O168Hzub.js" as="script"><link rel="prefetch" href="/assets/index.html-DniJfhLj.js" as="script"><link rel="prefetch" href="/assets/index.html-BEzFLeHh.js" as="script"><link rel="prefetch" href="/assets/index.html-BRLCT_BN.js" as="script"><link rel="prefetch" href="/assets/index.html-BP584IQ3.js" as="script"><link rel="prefetch" href="/assets/index.html-DiC1O1Ax.js" as="script"><link rel="prefetch" href="/assets/index.html-D90SXfFr.js" as="script"><link rel="prefetch" href="/assets/index.html-BNpDWYtf.js" as="script"><link rel="prefetch" href="/assets/index.html-alr6WcVo.js" as="script"><link rel="prefetch" href="/assets/index.html-it_0ais0.js" as="script"><link rel="prefetch" href="/assets/index.html-CkokxN5S.js" as="script"><link rel="prefetch" href="/assets/index.html-BAI6eOHS.js" as="script"><link rel="prefetch" href="/assets/index.html-CP1yCmGW.js" as="script"><link rel="prefetch" href="/assets/index.html-CJi0xWjC.js" as="script"><link rel="prefetch" href="/assets/index.html-BtZXldWM.js" as="script"><link rel="prefetch" href="/assets/index.html-D-12mSAm.js" as="script"><link rel="prefetch" href="/assets/index.html-B3gXpjn6.js" as="script"><link rel="prefetch" href="/assets/index.html-C9-BaaHE.js" as="script"><link rel="prefetch" href="/assets/index.html-j6_nL17M.js" as="script"><link rel="prefetch" href="/assets/index.html-C1KojdIT.js" as="script"><link rel="prefetch" href="/assets/index.html-lg5VYVz3.js" as="script"><link rel="prefetch" href="/assets/index.html-BIU39ge-.js" as="script"><link rel="prefetch" href="/assets/index.html-DJvVWLWM.js" as="script"><link rel="prefetch" href="/assets/index.html-D24P-MNU.js" as="script"><link rel="prefetch" href="/assets/index.html-kVoGGZ2e.js" as="script"><link rel="prefetch" href="/assets/index.html-rkHfaIFy.js" as="script"><link rel="prefetch" href="/assets/index.html-CKy1pClH.js" as="script"><link rel="prefetch" href="/assets/index.html-WYd6dPA0.js" as="script"><link rel="prefetch" href="/assets/index.html-xVVroEzJ.js" as="script"><link rel="prefetch" href="/assets/index.html-8wNkETrr.js" as="script"><link rel="prefetch" href="/assets/index.html-DxOsxKpn.js" as="script"><link rel="prefetch" href="/assets/index.html-BweR4Y_o.js" as="script"><link rel="prefetch" href="/assets/index.html-CQJESsKL.js" as="script"><link rel="prefetch" href="/assets/index.html-BpJQjCmQ.js" as="script"><link rel="prefetch" href="/assets/index.html-Bo6fQ3Zx.js" as="script"><link rel="prefetch" href="/assets/index.html-rHxloUxJ.js" as="script"><link rel="prefetch" href="/assets/index.html-BJrQMOHm.js" as="script"><link rel="prefetch" href="/assets/index.html-CBGxfD4Z.js" as="script"><link rel="prefetch" href="/assets/index.html-Xa7aDlJW.js" as="script"><link rel="prefetch" href="/assets/index.html-DOfAxhSH.js" as="script"><link rel="prefetch" href="/assets/index.html-_-CFOq0R.js" as="script"><link rel="prefetch" href="/assets/index.html-BLEYtSuq.js" as="script"><link rel="prefetch" href="/assets/index.html-Cj2yzscc.js" as="script"><link rel="prefetch" href="/assets/giscus-_nrdy_5Y.js" as="script"><link rel="prefetch" href="/assets/flowchart-CAFN9Lqb.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-JPGEtuxo.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-CMg0yb1C.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">doc</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog.html" aria-label="Blog"><!--[--><span class="font-icon icon iconfont icon-blog" style=""></span><!--]-->Blog<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/java/" aria-label="Java"><!--[--><span class="font-icon icon iconfont icon-java" style=""></span><!--]-->Java<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/project/" aria-label="Project"><!--[--><span class="font-icon icon iconfont icon-app" style=""></span><!--]-->Project<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/web/" aria-label="Web"><!--[--><span class="font-icon icon iconfont icon-net" style=""></span><!--]-->Web<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/python/" aria-label="Python"><!--[--><span class="font-icon icon iconfont icon-python" style=""></span><!--]-->Python<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Other"><!--[--><span class="font-icon icon iconfont icon-project" style=""></span>Other<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/interview/" aria-label="Java面试题库"><!--[--><span class="font-icon icon iconfont icon-java" style=""></span><!--]-->Java面试题库<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/tool/theme.html" aria-label="Theme-Hope"><!--[--><span class="font-icon icon iconfont icon-web-design" style=""></span><!--]-->Theme-Hope<!----></a></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/ventixy/notebook" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><span class="font-icon icon iconfont icon-es6" style=""></span><a class="route-link auto-link vp-sidebar-title no-external-link-icon" href="/blog.html" aria-label="My Blog"><!---->My Blog<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/posts/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB.html" aria-label="常用网站导航"><!--[--><span class="font-icon icon iconfont icon-pen-to-square" style=""></span><!--]-->常用网站导航<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Computer and science</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">运维基础及环境搭建</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Java开发相关记录</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">数据库相关博客</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/posts/db/mysql-binlog.html" aria-label="Binlog"><!---->Binlog<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/posts/db/mysql-lock.html" aria-label="MySQL事务和锁监控"><!---->MySQL事务和锁监控<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/posts/db/mysql.html" aria-label="MySQL数据库"><!---->MySQL数据库<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">其他日常博客记录</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->MySQL事务和锁监控 | 锁的范围 | 死锁分析</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://www.ventix.top" target="_blank" rel="noopener noreferrer">ventixy</a></span><span property="author" content="ventixy"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-09T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 11 min</span><meta property="timeRequired" content="PT11M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color1 clickable" role="navigation">Database</span><span class="page-category-item color6 clickable" role="navigation">MySQL</span><!--]--><meta property="articleSection" content="Database,MySQL"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color1 clickable" role="navigation">Database</span><span class="page-tag-item color6 clickable" role="navigation">MySQL</span><span class="page-tag-item color8 clickable" role="navigation">Transaction</span><span class="page-tag-item color1 clickable" role="navigation">Locks</span><!--]--><meta property="keywords" content="Database,MySQL,Transaction,Locks"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#mysql事务和锁监控">MySQL事务和锁监控</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#不同版本的区别">不同版本的区别</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#data-locks">data_locks</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#data-lock-waits">data_lock_waits</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#mysql锁了什么">MySQL锁了什么</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#主键索引上的锁">主键索引上的锁</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#唯一索引上的锁">唯一索引上的锁</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#次级索引上的锁">次级索引上的锁</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#非索引字段">非索引字段</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#没有主键时的锁">没有主键时的锁</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#范围条件的锁">范围条件的锁</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#mysql阻塞与死锁">MySQL阻塞与死锁</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h2 id="mysql事务和锁监控" tabindex="-1"><a class="header-anchor" href="#mysql事务和锁监控"><span>MySQL事务和锁监控</span></a></h2><p><code>information_schema</code> 是 MySQL 提供的一个系统数据库，用于存储有关数据库结构和元数据的信息</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 显示当前所有活跃的 innodb 事务信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> information_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">innodb_trx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>performance_schema</code> 是一个动态性能监控工具，在 8.0 版本中经历了一系列重要的改进和增强</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 显示所有前台线程的信息  查看事务事件</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">threads</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> where</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> type</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;foreground&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--显示当前活动事务的状态信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">events_transactions_current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于这两个系统数据库更多的信息参照：<a href="https://dev.mysql.com/doc/refman/8.4/en/innodb-information-schema.html" target="_blank" rel="noopener noreferrer">Information_Schema</a>，<a href="https://dev.mysql.com/doc/refman/8.4/en/performance-schema.html" target="_blank" rel="noopener noreferrer">Performance Schema</a></p><h3 id="不同版本的区别" tabindex="-1"><a class="header-anchor" href="#不同版本的区别"><span>不同版本的区别</span></a></h3><ol><li><p><strong>MySQL 5.7</strong> 通过以下命令诊断锁等待和事务：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 显示 innodb 存储引擎的当前状态信息，包括锁、事务、死锁等详细信息</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">show engine innodb </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">\g;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 显示当前所有 innodb 锁的信息(等待和死锁)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> information_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">innodb_locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 显示当前等待锁的事务信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> information_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">innodb_lock_waits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>MySQL 8.0</strong>： 优先使用 <code>performance_schema</code>，通过以下命令获取详细锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 显示当前数据锁的状态信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 显示当前等待数据锁的事务信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_lock_waits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>如需精确锁监控，建议升级到 MySQL 8.0。</p><table><thead><tr><th>功能</th><th>MySQL 5.7</th><th>MySQL 8.0</th></tr></thead><tbody><tr><td>查看普通锁</td><td>无法直接查看，需结合事务和上下文推测。</td><td><code>PERFORMANCE_SCHEMA.DATA_LOCKS</code> 支持直接查看锁范围。</td></tr><tr><td>等待锁/死锁</td><td><code>INNODB_LOCKS</code> + <code>INNODB_LOCK_WAITS</code></td><td><code>PERFORMANCE_SCHEMA.DATA_LOCK_WAITS</code>。</td></tr><tr><td>事务监控</td><td><code>INNODB_TRX</code></td><td><code>PERFORMANCE_SCHEMA.EVENTS_TRANSACTIONS_CURRENT</code>。</td></tr></tbody></table><h3 id="data-locks" tabindex="-1"><a class="header-anchor" href="#data-locks"><span>data_locks</span></a></h3><p><code>performance_schema.data_locks</code> 表（<a href="https://dev.mysql.com/doc/refman/8.4/en/performance-schema-data-locks-table.html" target="_blank" rel="noopener noreferrer">The data_locks Table</a>） 记录了当前<strong>所有数据锁的状态信息</strong>。它包含了每个锁的详细属性，如锁类型、锁模式、锁定的对象等。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><table><thead><tr><th><strong>字段名</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td><strong>ENGINE</strong></td><td>锁所属的存储引擎（例如 <code>INNODB</code>）。</td></tr><tr><td><strong>ENGINE_LOCK_ID</strong></td><td>锁的唯一标识符，由存储引擎生成，用于区分不同锁。</td></tr><tr><td><strong>ENGINE_TRANSACTION_ID</strong></td><td>请求或持有该锁的事务 ID。对 InnoDB，可与 <code>INNODB_TRX.TRX_ID</code> 关联查看事务详情。</td></tr><tr><td><strong>THREAD_ID</strong></td><td>请求锁的会话线程 ID。可与 <code>performance_schema.threads</code> 关联获取线程信息。</td></tr><tr><td><strong>EVENT_ID</strong></td><td>锁创建事件的 ID。可与 Performance Schema 中其他表的事件关联，了解锁的生成过程。</td></tr><tr><td><strong>OBJECT_SCHEMA</strong></td><td>锁定对象所在的数据库名。</td></tr><tr><td><strong>OBJECT_NAME</strong></td><td>锁定的表名。</td></tr><tr><td><strong>PARTITION_NAME</strong></td><td>锁定的分区名（如果存在分区锁定）；如果没有分区锁定，则为 <code>NULL</code>。</td></tr><tr><td><strong>SUBPARTITION_NAME</strong></td><td>锁定的子分区名（如果存在子分区锁定）；如果没有子分区锁定，则为 <code>NULL</code>。</td></tr><tr><td><strong>INDEX_NAME</strong></td><td>锁定的索引名</td></tr><tr><td><strong>OBJECT_INSTANCE_BEGIN</strong></td><td>锁对象的内存地址，用于区分存储引擎内部的锁对象实例。</td></tr><tr><td><strong>LOCK_TYPE</strong></td><td>锁类型：<code>TABLE</code>（表锁）或 <code>RECORD</code>（行锁）。</td></tr><tr><td><strong>LOCK_MODE</strong></td><td>锁的模式，表示锁的粒度和权限，包括：<br><code>S</code>（共享锁）、<code>X</code>（排他锁）、<code>IS</code>（意向共享锁）、<code>IX</code>（意向排他锁）、<code>AUTO_INC</code>（自增锁）等。</td></tr><tr><td><strong>LOCK_STATUS</strong></td><td>锁的状态：<code>GRANTED</code>（已授予）或 <code>WAITING</code>（正在等待）。</td></tr><tr><td><strong>LOCK_DATA</strong></td><td>锁定数据的具体信息</td></tr></tbody></table><ul><li><strong>锁状态 (<code>LOCK_STATUS</code>)：</strong> 用于判断是否存在锁等待问题，是排查锁争用的关键字段。</li><li><strong>锁模式 (<code>LOCK_MODE</code>)：</strong> 提供锁类型的详细信息，包括是否存在间隙锁（<code>GAP</code>）。</li><li><strong>锁定对象 (<code>OBJECT_SCHEMA</code>, <code>OBJECT_NAME</code>, <code>INDEX_NAME</code>)：</strong> 帮助快速定位被锁定的表、分区或索引</li><li><strong>事务 ID (<code>ENGINE_TRANSACTION_ID</code>) 和线程 ID (<code>THREAD_ID</code>)：</strong> 用于关联锁与事务、线程的上下文信息，分析锁的来源及对性能的影响。</li></ul><h3 id="data-lock-waits" tabindex="-1"><a class="header-anchor" href="#data-lock-waits"><span>data_lock_waits</span></a></h3><p><code>performance_schema.data_lock_waits</code> 表 （<a href="https://dev.mysql.com/doc/refman/8.4/en/performance-schema-data-lock-waits-table.html" target="_blank" rel="noopener noreferrer">The data_lock_waits Table</a>） 记录了当前所有<strong>等待锁</strong>的事务信息。它展示了哪些事务正在等待其他事务释放锁，形成了锁等待链。通过这个表，你可以追踪锁等待的情况，帮助识别和解决锁冲突和死锁问题。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_lock_waits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><table><thead><tr><th><strong>字段名</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td><strong>ENGINE</strong></td><td>请求或阻塞锁所属的存储引擎（例如 <code>INNODB</code>）</td></tr><tr><td><strong>REQUESTING_ENGINE_LOCK_ID</strong></td><td>请求的锁的唯一标识符。可与 <code>data_locks.ENGINE_LOCK_ID</code> 关联查询请求锁的详情。</td></tr><tr><td><strong>REQUESTING_ENGINE_TRANSACTION_ID</strong></td><td>请求锁的事务 ID。</td></tr><tr><td><strong>REQUESTING_THREAD_ID</strong></td><td>请求锁的会话线程 ID。</td></tr><tr><td><strong>REQUESTING_EVENT_ID</strong></td><td>请求锁的事件 ID。可与 Performance Schema 中的事件表关联，了解锁请求的上下文信息。</td></tr><tr><td><strong>REQUESTING_OBJECT_INSTANCE_BEGIN</strong></td><td>请求锁的内存地址。</td></tr><tr><td><strong>BLOCKING_ENGINE_LOCK_ID</strong></td><td>阻塞锁的唯一标识符。可与 <code>data_locks.ENGINE_LOCK_ID</code> 关联查询持有锁的详情。</td></tr><tr><td><strong>BLOCKING_ENGINE_TRANSACTION_ID</strong></td><td>持有阻塞锁的事务 ID。</td></tr><tr><td><strong>BLOCKING_THREAD_ID</strong></td><td>持有阻塞锁的会话线程 ID。</td></tr><tr><td><strong>BLOCKING_EVENT_ID</strong></td><td>持有阻塞锁的事件 ID。</td></tr><tr><td><strong>BLOCKING_OBJECT_INSTANCE_BEGIN</strong></td><td>持有锁的内存地址。</td></tr></tbody></table><p><strong>应用场景</strong></p><ol><li><p><strong>锁等待分析：</strong> 通过 <code>REQUESTING_ENGINE_LOCK_ID</code> 和 <code>BLOCKING_ENGINE_LOCK_ID</code>，了解等待的锁和阻塞的锁之间的关系。 帮助确定锁争用的来源和被影响的事务。</p></li><li><p><strong>事务依赖分析：</strong><br> 结合 <code>REQUESTING_ENGINE_TRANSACTION_ID</code> 和 <code>BLOCKING_ENGINE_TRANSACTION_ID</code>，分析事务间的锁依赖关系，定位可能导致性能瓶颈的事务。</p></li><li><p><strong>结合 <code>data_locks</code> 表：</strong> 关联 <code>data_locks</code> 表中的详细锁信息，获取被锁定的表、索引及锁类型（如 <code>TABLE</code> 或 <code>RECORD</code>）。</p></li><li><p><strong>死锁排查：</strong> 在发生死锁时，通过锁等待链，迅速找到阻塞点并优化相关事务或 SQL。</p></li></ol><p><strong>示例用法</strong> :</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_lock_waits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">--查看当前所有锁等待信息</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>关联 <code>data_locks</code> 表，查看等待锁和阻塞锁的具体信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dl1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">THREAD_ID</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> AS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> requesting_thread,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       dl1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">LOCK_TYPE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> AS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> requesting_lock_type,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       dl2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">THREAD_ID</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> AS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> blocking_thread,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       dl2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">LOCK_TYPE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> AS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> blocking_lock_type</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_lock_waits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dw</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">JOIN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dl1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  ON</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">REQUESTING_ENGINE_LOCK_ID</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dl1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">ENGINE_LOCK_ID</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">JOIN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dl2</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  ON</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dw</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">BLOCKING_ENGINE_LOCK_ID</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dl2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">ENGINE_LOCK_ID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="mysql锁了什么" tabindex="-1"><a class="header-anchor" href="#mysql锁了什么"><span>MySQL锁了什么</span></a></h2><p>MySQL在进行 update 等操作或锁定读时，究竟加了什么锁，锁了什么，接下来借助MySQL8提供的<code>performance_schema.data_locks</code>进行分析</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> OBJECT_NAME, INDEX_NAME, LOCK_STATUS, LOCK_TYPE, LOCK_MODE, LOCK_DATA</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> performance_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">data_locks</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">performance_schema.data_locks.LOCK_MODE</p><p>MySQL的<code>data_locks</code>表中的<code>LOCK_MODE</code>的三种形式描述：</p><ul><li><code>X</code> ： Next-key Locks，临键锁 ，同时锁定 <strong>记录本身</strong> 和 <strong>记录与前一条记录之间的间隙</strong></li><li><code>X,REC_NOT_GAP</code>: 记录所，仅对记录加锁</li><li><code>X,GAP </code>： 间隙锁（Gap Locks），仅对间隙加锁，防止其他事务在间隙中插入数据</li></ul></div><p>先创建示例表：（环境为MySQL8.0，RR隔离级别）</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 创建 users 表</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> users</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    id </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> AUTO_INCREMENT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY KEY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,     </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 主键</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    name</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> VARCHAR</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),                      </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 用户名，普通索引</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    age </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,                               </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 年龄</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    phone </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VARCHAR</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">UNIQUE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,              </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 唯一索引字段</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    INDEX</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)                           </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 为 name 字段创建普通二级索引</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 插入数据</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INSERT INTO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users (id, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, age, phone) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VALUES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Alice&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">25</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;1234567890&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Bob&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">30</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;666888&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Charlie&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;1122334455&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 创建 t1 表（无任何索引）</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> t1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ( </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> VARCHAR</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),  age </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> );</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 插入数据</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INSERT INTO</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> t1 (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, age) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VALUES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;David&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">28</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">), (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Eve&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面的实验中，每次事务均会进行 <code>rollback;</code> ，后面不再说明</p><h3 id="主键索引上的锁" tabindex="-1"><a class="header-anchor" href="#主键索引上的锁"><span>主键索引上的锁</span></a></h3><p>开启事务，在users表上做一个锁定读，查询条件针对主键id：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后通过查询<code>data_locks</code>表得到下面的信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-----------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE     | LOCK_DATA |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-----------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX            | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X,REC_NOT_GAP | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">         |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-----------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该事务中加了两个锁，表级的意向排他锁（IX）和针对主键索引的 排他锁（X），通过<code>LOCK_DATA</code>可知，锁定的就是主键id为4的这条聚集索引树上的记录</p><h3 id="唯一索引上的锁" tabindex="-1"><a class="header-anchor" href="#唯一索引上的锁"><span>唯一索引上的锁</span></a></h3><p>开启事务，在users表上做一个锁定读，查询条件在唯一索引<code>phone</code>上：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> phone </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;666888&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后通过查询<code>data_locks</code>表查询到下面的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE     | LOCK_DATA   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX            | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | phone      | GRANTED     | RECORD    | X,REC_NOT_GAP | </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;666888&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X,REC_NOT_GAP | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">           |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>表级锁：加了意向排他锁（IX）。</li><li>索引级锁： <ul><li>唯一索引 <code>phone</code> 对应的记录加了 <code>X, REC_NOT_GAP</code> 锁。</li><li>主键索引 <code>id</code> 对应的记录也加了 <code>X, REC_NOT_GAP</code> 锁。</li></ul></li></ul><p>唯一索引因为有唯一性约束，所以只加记录锁，不用加间隙锁。</p><h3 id="次级索引上的锁" tabindex="-1"><a class="header-anchor" href="#次级索引上的锁"><span>次级索引上的锁</span></a></h3><p>开启事务，在users表上做一个锁定读，查询条件在普通二级索引<code>name</code>上：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Bob&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后通过查询<code>data_locks</code>表查询到下面的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+---------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE     | LOCK_DATA     |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+---------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX            | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | RECORD    | X,GAP         | </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Charlie&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | RECORD    | X             | </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Bob&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X,REC_NOT_GAP | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+---------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>TABLE | IX | NULL</code> : 表级意向锁（Intent Exclusive, IX）</p></li><li><p><code>name | X,GAP | &#39;Charlie&#39;, 18</code>: 间隙锁（<strong>锁定的是当前记录的前一条记录和当前记录之间的间隙范围</strong>），这里表示锁住的是二级索引树上从 <code>(&#39;Bob&#39;, id=4) </code>到 <code>(&#39;Charlie&#39;, id=18) </code>的间隙</p></li><li><p><code>name | X | &#39;Bob&#39;, 4</code>: <strong>临键锁（Next-key Locks）</strong>，锁记录和间隙，即锁定 <code>(&#39;Bob&#39;, id=4)</code>这条记录 及 <code>(&#39;Alice&#39;, id=3)</code>到 <code>(&#39;Bob&#39;, id=4)</code>之间的间隙</p></li><li><p><code>PRIMARY | X,REC_NOT_GAP | 4</code>: 主键 <code>id=4</code> 上的记录锁（<code>REC_NOT_GAP</code>，不锁间隙）</p></li></ul><div class="hint-container important"><p class="hint-container-title">唯一索引和普通索引的加锁区别</p><p>唯一索引和普通索引加锁都需要对非聚集索引加锁，再对主键索引加锁</p><table><thead><tr><th><strong>特性</strong></th><th><strong>唯一索引</strong></th><th><strong>普通索引</strong></th></tr></thead><tbody><tr><td><strong>锁定记录</strong></td><td>是 （记录锁, 如： <code>X, REC_NOT_GAP</code>）</td><td>是 (记录锁, 如： <code>X</code>)</td></tr><tr><td><strong>是否加间隙锁</strong></td><td>否</td><td>是 (记录锁, 如： <code>X</code>)</td></tr><tr><td><strong>原因</strong></td><td>唯一性约束确保无重复值</td><td>需要防止相同索引值的插入</td></tr><tr><td><strong>并发性</strong></td><td>高</td><td>较低</td></tr></tbody></table><ul><li>唯一索引由于天然的唯一性约束，只需要锁定目标记录，具备更高的并发性能。</li><li>普通索引需要额外的间隙锁，来防止重复值插入或“幻读”，因此加锁范围更广，并发性能相对较低。</li></ul></div><h3 id="非索引字段" tabindex="-1"><a class="header-anchor" href="#非索引字段"><span>非索引字段</span></a></h3><p>开启事务，在users表上做一个锁定读，查询条件不在索引上：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> age </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后通过查询<code>data_locks</code>表查询到下面的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+-----------+------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE | LOCK_DATA              |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+-----------+------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX        | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | supremum pseudo-record |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                     |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+-----------+------------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1个表级意向排他锁，4个临键锁（Next-key Locks）, 锁住了所有记录及间隙</p><h3 id="没有主键时的锁" tabindex="-1"><a class="header-anchor" href="#没有主键时的锁"><span>没有主键时的锁</span></a></h3><p>开启事务，在t1表上做一个锁定读，查询条件为name：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> t1 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;David&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后通过查询<code>data_locks</code>表查询到下面的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+-----------------+-------------+---------+-------+-------------------- ----+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME      | LOCK_STATUS |LOCK_TYPE|LOCK_MODE| LOCK_DATA             |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+-----------------+-------------+-----------+-----------+-------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| t1          | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   | IX      | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                  |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| t1          | GEN_CLUST_INDEX | GRANTED     | RECORD  | X       | supremum pseudo-record|</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| t1          | GEN_CLUST_INDEX | GRANTED     | RECORD  | X       | 0x000000000202        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| t1          | GEN_CLUST_INDEX | GRANTED     | RECORD  | X       | 0x000000000203        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+-----------------+-------------+---------+------ - +------------------ ----+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该事务中加了4个锁，表级的意向排他锁（IX）和 3个 排他锁（X）：</p><ul><li><code>supremum pseudo-record</code>：表示无穷大区间，锁住了最大索引到无穷大的范围</li><li><code>0x000000000202</code>和<code>0x000000000203</code>: 临键锁（Next-key Locks）对记录和间隙都加排他锁。</li></ul><p>在没有显式主键的表中，InnoDB 会使用隐藏的聚簇索引（<code>GEN_CLUST_INDEX</code>）来管理数据。由于缺乏显式主键或索引，更新操作通常需要扫描全表，并在所有记录和间隙上加锁。</p><p><code>GEN_CLUST_INDEX</code>表示表的聚簇索引（内部生成的主键索引）</p><p>从该示例可以看出，没有显式主键的表在RR隔离级别下更新数据会加很多锁，最终范围与表锁几乎一致，所以一定要避免创建没有显式主键的表</p><h3 id="范围条件的锁" tabindex="-1"><a class="header-anchor" href="#范围条件的锁"><span>范围条件的锁</span></a></h3><p>还是上面的表和数据，这次只看条件和加锁情况，原有数据如下：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">mysql</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+---------+------+------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| id | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | age  | phone      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+---------+------+------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|  </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | Alice   |   </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">25</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1234567890</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">|  </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | Bob     |   </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">30</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">666888</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | Charlie |   </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1122334455</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">----+---------+------+------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">不同情形下的范围条件加锁示例</p><h4 id="_1-主键索引上的范围条件" tabindex="-1"><a class="header-anchor" href="#_1-主键索引上的范围条件"><span>1. 主键索引上的范围条件</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> and</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过查询<code>data_locks</code>表查询到的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-----------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE     | LOCK_DATA |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-----------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX            | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X,GAP         | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X,REC_NOT_GAP | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">         |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+-----------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>加锁范围：主键索引的 <code>[4, 18)</code></p><h4 id="_2-唯一索引上的范围条件" tabindex="-1"><a class="header-anchor" href="#_2-唯一索引上的范围条件"><span>2. 唯一索引上的范围条件</span></a></h4><p>注意 数字字符串 的排序：从小到大的字典序排序，<code>&#39;1122334455&#39;</code>, <code>&#39;1234567890&#39;</code>, <code>&#39;666888&#39;</code></p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> phone </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;666888&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> and</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> phone </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;999999&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过查询<code>data_locks</code>表查询到的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">------------+-------------+-----------+---------------+------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE     | LOCK_DATA              |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">------------+-------------+-----------+---------------+------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX            | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| phone      | GRANTED     | RECORD    | X             | supremum pseudo-record |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| phone      | GRANTED     | RECORD    | X             | </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;666888&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X,REC_NOT_GAP | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">------------+-------------+-----------+---------------+------------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>加锁范围：</p><ul><li>唯一索引的 (<code>&#39;1234567890&#39;</code>, <code>&#39;666888&#39;</code>]， <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:-0.566ex;" xmlns="http://www.w3.org/2000/svg" width="13.071ex" height="2.351ex" role="img" focusable="false" viewBox="0 -789 5777.6 1039" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(422,363) scale(0.707)"><path data-c="2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"></path></g></g><g data-mml-node="msup" transform="translate(666.5,0)"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1000,0)"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(1500,0)"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(2000,0)"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(2500,0)"></path></g><g data-mml-node="mo" transform="translate(3033,393.1) scale(0.707)"><path data-c="2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"></path></g></g><g data-mml-node="mo" transform="translate(3943.9,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(4388.6,0)"><path data-c="221E" d="M55 217Q55 305 111 373T254 442Q342 442 419 381Q457 350 493 303L507 284L514 294Q618 442 747 442Q833 442 888 374T944 214Q944 128 889 59T743 -11Q657 -11 580 50Q542 81 506 128L492 147L485 137Q381 -11 252 -11Q166 -11 111 57T55 217ZM907 217Q907 285 869 341T761 397Q740 397 720 392T682 378T648 359T619 335T594 310T574 285T559 263T548 246L543 238L574 198Q605 158 622 138T664 94T714 61T765 51Q827 51 867 100T907 217ZM92 214Q92 145 131 89T239 33Q357 33 456 193L425 233Q364 312 334 337Q285 380 233 380Q171 380 132 331T92 214Z"></path></g><g data-mml-node="mo" transform="translate(5388.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mo stretchy="false">(</mo><mo data-mjx-alternate="1">′</mo></msup><msup><mn>666888</mn><mo data-mjx-alternate="1">′</mo></msup><mo>,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container><br> (为什么这里会包含<code>&#39;666888&#39;</code>之前的间隙)</li><li>主键索引的 <code>4</code></li></ul><h4 id="_3-普通二级索引上的范围条件" tabindex="-1"><a class="header-anchor" href="#_3-普通二级索引上的范围条件"><span>3. 普通二级索引上的范围条件</span></a></h4><p>注意从小到大的字典序排序，<code>&#39;Alice&#39;</code>, <code>&#39;Bob&#39;</code>, <code>&#39;Charlie&#39;</code></p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Bob&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> and</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CC&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过查询<code>data_locks</code>表查询到的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE     | LOCK_DATA     |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+---------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX            | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | RECORD    | X             | </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Bob&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | RECORD    | X             | </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Charlie&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X,REC_NOT_GAP | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+---------------+---------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-非索引字段上的范围条件" tabindex="-1"><a class="header-anchor" href="#_4-非索引字段上的范围条件"><span>4. 非索引字段上的范围条件</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">start transaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> users </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> age </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 22</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> and</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> age </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 28</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过查询<code>data_locks</code>表查询到的锁信息：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+-----------+------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| OBJECT_NAME | INDEX_NAME | LOCK_STATUS | LOCK_TYPE | LOCK_MODE | LOCK_DATA              |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+-----------+------------------------+</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       | GRANTED     | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TABLE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     | IX        | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                   |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | supremum pseudo-record |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">| users       | </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">PRIMARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    | GRANTED     | RECORD    | X         | </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                     |</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">+</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-------------+------------+-------------+-----------+-----------+------------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>全锁了~</p></div><h2 id="mysql阻塞与死锁" tabindex="-1"><a class="header-anchor" href="#mysql阻塞与死锁"><span>MySQL阻塞与死锁</span></a></h2><p>在 MySQL 中，<strong>锁阻塞</strong>（Lock Blocking）是指一个事务（或会话）因为另一个事务持有的锁而无法获取所需的锁，导致该事务必须等待的情况。具体来说，当一个事务试图获取某个资源上的锁，但该资源已经被另一个事务锁定时，前者就会进入等待状态，直到后者释放锁。</p><p>可根据需要调整 <code>innodb_lock_wait_timeout</code> 参数，设置合理的锁等待超时时间。</p><ul><li>启用 <code>innodb_print_all_deadlocks</code> 参数，记录所有死锁信息，帮助分析和解决问题。</li></ul></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/ventixy/notebook/edit/main/src/posts/db/mysql-lock.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">Last update: </span><!----></div><div class="contributors"><span class="vp-meta-label">Contributors: </span><!--[--><!--[--><span class="vp-meta-info" title="email: msdrizzle@outlook.com">drizzle</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/posts/db/mysql-binlog.html" aria-label="Binlog"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->Binlog</div></a><a class="route-link auto-link next" href="/posts/db/mysql.html" aria-label="MySQL数据库"><div class="hint">Next<span class="arrow end"></span></div><div class="link">MySQL数据库<!----></div></a></nav><div id="vp-comment" class="giscus-wrapper input-top" style="display:block;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">Default footer</div><div class="vp-copyright">Copyright © 2025 ventixy </div></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DROnWr0m.js" defer></script>
  </body>
</html>
